# æ•°æ®åº“æ¸…ç†æ“ä½œæŒ‡å—

## ğŸ“‹ å½“å‰çŠ¶æ€

å·²åˆ é™¤ä»¥ä¸‹æœªä½¿ç”¨çš„æ•°æ®åº“è¡¨å®šä¹‰ï¼š
- âŒ `AdminUser`
- âŒ `SiteConfig`
- âŒ `PasswordResetToken`

å½“å‰æ•°æ®åº“åªåŒ…å«ä»¥ä¸‹ **5 ä¸ªè¡¨**ï¼š
- âœ… `User`
- âœ… `Page`
- âœ… `UserPasswordResetToken`
- âœ… `MediaAsset`
- âœ… `NewsArticle`

## ğŸ”§ å…·ä½“æ“ä½œæ­¥éª¤

### æ­¥éª¤ 1ï¼šæ›´æ–° Prisma Client

åˆ é™¤è¡¨å®šä¹‰åï¼Œéœ€è¦é‡æ–°ç”Ÿæˆ Prisma Clientï¼š

```bash
cd v-module-frontend
npx prisma generate
```

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ” Generated Prisma Client (X.XX.XX) to ./node_modules/.prisma/client in XXXms
```

### æ­¥éª¤ 2ï¼šéªŒè¯æ•°æ®åº“ç»“æ„

åœ¨ Supabase Dashboard ä¸­æ£€æŸ¥è¡¨ç»“æ„ï¼š

1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥ **Table Editor**
3. ç¡®è®¤ä»¥ä¸‹è¡¨å­˜åœ¨ï¼š
   - âœ… `User`
   - âœ… `Page`
   - âœ… `UserPasswordResetToken`
   - âœ… `MediaAsset`
   - âœ… `NewsArticle`

### æ­¥éª¤ 3ï¼šæµ‹è¯•é¡¹ç›®è¿è¡Œ

#### 3.1 å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
```

#### 3.2 æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½

**æµ‹è¯•ç”¨æˆ·ç™»å½•**ï¼š
1. è®¿é—® `http://localhost:3000/admin`
2. ä½¿ç”¨ç°æœ‰ç”¨æˆ·ç™»å½•ï¼ˆæˆ–æ³¨å†Œæ–°ç”¨æˆ·ï¼‰
3. âœ… åº”è¯¥èƒ½æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ° `/admin/dashboard`

**æµ‹è¯•é¡µé¢ç¼–è¾‘**ï¼š
1. ç™»å½•åè®¿é—® `/admin/cms`
2. âœ… åº”è¯¥èƒ½æ­£å¸¸åŠ è½½é¡µé¢ç¼–è¾‘å™¨
3. âœ… åº”è¯¥èƒ½ä¿å­˜è‰ç¨¿å’Œå‘å¸ƒé…ç½®

**æµ‹è¯•å›¾ç‰‡ä¸Šä¼ **ï¼š
1. åœ¨ CMS ç¼–è¾‘å™¨ä¸­ä¸Šä¼ å›¾ç‰‡
2. âœ… åº”è¯¥èƒ½æˆåŠŸä¸Šä¼ å¹¶æ˜¾ç¤º

**æµ‹è¯•æ–°é—»æ–‡ç« **ï¼š
1. åœ¨ CMS ç¼–è¾‘å™¨ä¸­åˆ›å»ºæ–°é—»æ–‡ç« 
2. âœ… åº”è¯¥èƒ½æˆåŠŸåˆ›å»ºã€ç¼–è¾‘å’Œåˆ é™¤

### æ­¥éª¤ 4ï¼šæ£€æŸ¥ç¼–è¯‘é”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰

å¦‚æœé‡åˆ° TypeScript ç¼–è¯‘é”™è¯¯ï¼Œè¿è¡Œï¼š

```bash
pnpm build
```

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**ï¼š

#### é”™è¯¯ 1ï¼š`Property 'adminUser' does not exist`
**åŸå› **ï¼šä»£ç ä¸­ä»åœ¨ä½¿ç”¨å·²åˆ é™¤çš„ `adminUser` å…³ç³»  
**è§£å†³**ï¼šæ£€æŸ¥å¹¶æ›´æ–°ç›¸å…³ä»£ç ï¼Œä½¿ç”¨ `user` è€Œä¸æ˜¯ `adminUser`

#### é”™è¯¯ 2ï¼š`Cannot find module '@/lib/passwordReset'`
**åŸå› **ï¼šä»£ç ä¸­å¯¼å…¥äº†å·²åˆ é™¤çš„ `lib/passwordReset.ts`  
**è§£å†³**ï¼šä½¿ç”¨ `@/lib/userPasswordReset` æ›¿ä»£

#### é”™è¯¯ 3ï¼š`prisma.adminUser is not defined`
**åŸå› **ï¼šä»£ç ä¸­ä½¿ç”¨äº† `prisma.adminUser`  
**è§£å†³**ï¼šä½¿ç”¨ `prisma.user` æ›¿ä»£

## ğŸ“Š æ•°æ®åº“è¡¨è¯¦ç»†è¯´æ˜

### 1. **User**ï¼ˆç”¨æˆ·è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨æ™®é€šç”¨æˆ·ï¼ˆVTuberï¼‰è´¦æˆ·ä¿¡æ¯

**ä¸»è¦å­—æ®µ**ï¼š
- `id`ï¼šç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆCUIDï¼‰
- `slug`ï¼šURL å‹å¥½æ ‡è¯†ï¼Œç”¨äº `/u/[slug]` è·¯ç”±ï¼ˆå”¯ä¸€ï¼‰
- `email`ï¼šç™»å½•é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰
- `passwordHash`ï¼šbcrypt åŠ å¯†åçš„å¯†ç 
- `displayName`ï¼šæ˜¾ç¤ºåç§°ï¼ˆå¯é€‰ï¼‰

**å…³ç³»**ï¼š
- 1:1 â†’ `Page`ï¼ˆæ¯ä¸ªç”¨æˆ·ä¸€ä¸ªé¡µé¢ï¼‰
- 1:N â†’ `UserPasswordResetToken`ï¼ˆå¯†ç é‡ç½® Tokenï¼‰
- 1:N â†’ `MediaAsset`ï¼ˆä¸Šä¼ çš„åª’ä½“èµ„æºï¼‰
- 1:N â†’ `NewsArticle`ï¼ˆåˆ›å»ºçš„æ–°é—»æ–‡ç« ï¼‰

### 2. **Page**ï¼ˆé¡µé¢é…ç½®è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨ç”¨æˆ·çš„ä¸ªäººé¡µé¢é…ç½®ï¼Œæ”¯æŒè‰ç¨¿ä¸å‘å¸ƒç‰ˆæœ¬åˆ†ç¦»

**ä¸»è¦å­—æ®µ**ï¼š
- `id`ï¼šé¡µé¢å”¯ä¸€æ ‡è¯†ï¼ˆCUIDï¼‰
- `userId`ï¼šç”¨æˆ·IDï¼ˆå”¯ä¸€ï¼Œä¸€å¯¹ä¸€å…³ç³»ï¼‰
- `slug`ï¼šé¡µé¢ slugï¼Œç”¨äº `/u/[slug]` è·¯ç”±ï¼ˆå”¯ä¸€ï¼‰
- `draftConfig`ï¼šè‰ç¨¿é…ç½®ï¼ˆJSONï¼Œç¼–è¾‘æ—¶ä¿å­˜ï¼‰
- `publishedConfig`ï¼šå‘å¸ƒé…ç½®ï¼ˆJSONï¼Œå…¬å¼€å¯è§ï¼‰

**å…³ç³»**ï¼š
- N:1 â†’ `User`ï¼ˆå±äºä¸€ä¸ªç”¨æˆ·ï¼‰

### 3. **UserPasswordResetToken**ï¼ˆç”¨æˆ·å¯†ç é‡ç½® Token è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨ç”¨æˆ·çš„å¯†ç é‡ç½®ä»¤ç‰Œ

**ä¸»è¦å­—æ®µ**ï¼š
- `id`ï¼šToken å”¯ä¸€æ ‡è¯†ï¼ˆCUIDï¼‰
- `tokenHash`ï¼šå“ˆå¸Œåçš„ tokenï¼ˆå”¯ä¸€ï¼‰
- `userId`ï¼šç”¨æˆ·ID
- `expiresAt`ï¼šè¿‡æœŸæ—¶é—´
- `used`ï¼šæ˜¯å¦å·²ä½¿ç”¨ï¼ˆé»˜è®¤ falseï¼‰

**å…³ç³»**ï¼š
- N:1 â†’ `User`ï¼ˆå±äºä¸€ä¸ªç”¨æˆ·ï¼‰

### 4. **MediaAsset**ï¼ˆåª’ä½“èµ„æºè¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ç­‰åª’ä½“æ–‡ä»¶ä¿¡æ¯

**ä¸»è¦å­—æ®µ**ï¼š
- `id`ï¼šèµ„æºå”¯ä¸€æ ‡è¯†ï¼ˆCUIDï¼‰
- `userId`ï¼šç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
- `src`ï¼šæ–‡ä»¶è·¯å¾„ï¼ˆæœ¬åœ°è·¯å¾„æˆ– S3/R2 URLï¼‰
- `mimeType`ï¼šMIME ç±»å‹
- `size`ï¼šæ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
- `originalName`ï¼šåŸå§‹æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰

**å…³ç³»**ï¼š
- N:1 â†’ `User`ï¼ˆå±äºä¸€ä¸ªç”¨æˆ·ï¼Œå¯é€‰ï¼‰

### 5. **NewsArticle**ï¼ˆæ–°é—»æ–‡ç« è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„æ–°é—»/æ–‡ç« 

**ä¸»è¦å­—æ®µ**ï¼š
- `id`ï¼šæ–‡ç« å”¯ä¸€æ ‡è¯†ï¼ˆCUIDï¼‰
- `userId`ï¼šæ‰€å±ç”¨æˆ·ID
- `title`ï¼šæ ‡é¢˜
- `content`ï¼šå†…å®¹ï¼ˆæ”¯æŒ Markdownï¼ŒTEXT ç±»å‹ï¼‰
- `category`ï¼šåˆ†ç±»ï¼ˆå¦‚ "MEDIA", "MAGAZINE", "ã‚ã®", "ANO"ï¼‰
- `tag`ï¼šæ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
- `shareUrl`ï¼šåˆ†äº«é“¾æ¥ï¼ˆå¯é€‰ï¼‰
- `shareChannels`ï¼šåˆ†äº«æ¸ é“é…ç½®ï¼ˆJSONï¼Œå¯é€‰ï¼‰
- `backgroundType`ï¼šèƒŒæ™¯ç±»å‹ï¼ˆ"color" æˆ– "image"ï¼Œé»˜è®¤ "color"ï¼‰
- `backgroundValue`ï¼šèƒŒæ™¯å€¼ï¼ˆé¢œè‰²å€¼æˆ–å›¾ç‰‡URLï¼Œé»˜è®¤ "#000000"ï¼‰
- `published`ï¼šæ˜¯å¦å‘å¸ƒï¼ˆé»˜è®¤ falseï¼‰
- `publishedAt`ï¼šå‘å¸ƒæ—¶é—´ï¼ˆå¯é€‰ï¼‰

**å…³ç³»**ï¼š
- N:1 â†’ `User`ï¼ˆå±äºä¸€ä¸ªç”¨æˆ·ï¼‰

## ğŸ”„ API ç«¯ç‚¹æ˜ å°„

### ç”¨æˆ·ç›¸å…³ APIï¼ˆå·²è¿ç§»åˆ° `/api/user/*`ï¼‰

| æ—§ç«¯ç‚¹ï¼ˆå·²åˆ é™¤ï¼‰ | æ–°ç«¯ç‚¹ï¼ˆä½¿ç”¨ä¸­ï¼‰ | çŠ¶æ€ |
|----------------|----------------|------|
| `POST /api/admin/login` | `POST /api/user/login` | âœ… |
| `POST /api/admin/register` | `POST /api/user/register` | âœ… |
| `POST /api/admin/forgot-password` | `POST /api/user/forgot-password` | âœ… |
| `POST /api/admin/reset-password` | `POST /api/user/reset-password` | âœ… |
| `GET /api/admin/me` | `GET /api/user/me` | âœ… |

## âœ… éªŒè¯æ¸…å•

å®Œæˆæ¸…ç†åï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] Prisma Client å·²é‡æ–°ç”Ÿæˆï¼ˆ`npx prisma generate`ï¼‰
- [ ] æ•°æ®åº“ä¸­å­˜åœ¨ 5 ä¸ªè¡¨ï¼ˆUser, Page, UserPasswordResetToken, MediaAsset, NewsArticleï¼‰
- [ ] é¡¹ç›®å¯ä»¥æ­£å¸¸å¯åŠ¨ï¼ˆ`pnpm dev`ï¼‰
- [ ] ç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•ï¼ˆ`/admin`ï¼‰
- [ ] ç”¨æˆ·å¯ä»¥æ­£å¸¸ç¼–è¾‘é¡µé¢ï¼ˆ`/admin/cms`ï¼‰
- [ ] å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ­£å¸¸ï¼ˆ`/api/page/me/upload`ï¼‰
- [ ] æ–°é—»æ–‡ç« åŠŸèƒ½æ­£å¸¸ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
- [ ] æ²¡æœ‰ TypeScript ç¼–è¯‘é”™è¯¯ï¼ˆ`pnpm build`ï¼‰

## ğŸ†˜ æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šPrisma Client ç”Ÿæˆå¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error: Schema parsing error
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `schema.prisma` æ–‡ä»¶è¯­æ³•
2. ç¡®ä¿æ‰€æœ‰è¡¨å®šä¹‰æ­£ç¡®
3. è¿è¡Œ `npx prisma format` æ ¼å¼åŒ– schema

### é—®é¢˜ 2ï¼šæ•°æ®åº“è¡¨ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Table 'User' does not exist
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ Supabase Dashboard ä¸­æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
2. å¦‚æœä¸å­˜åœ¨ï¼Œè¿è¡Œè¿ç§»ï¼š
   ```bash
   npx prisma migrate dev --name init_tables
   ```

### é—®é¢˜ 3ï¼šAPI è·¯ç”±è¿”å› 404

**é”™è¯¯ä¿¡æ¯**ï¼š
```
404 Not Found: /api/admin/login
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸º `/api/admin/*` è·¯ç”±å·²åˆ é™¤
- å‰ç«¯åº”ä½¿ç”¨ `/api/user/*` è·¯ç”±
- æ£€æŸ¥å‰ç«¯ä»£ç æ˜¯å¦ä»åœ¨ä½¿ç”¨æ—§ç«¯ç‚¹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ¸…ç†å½±å“åˆ†æ](./DATABASE_CLEANUP_ANALYSIS.md)
- [æ•°æ®åº“è®¾ç½®æŒ‡å—](./DATABASE_SETUP.md)
- [è¿ç§»æ€»ç»“](./MIGRATION_SUMMARY.md)

